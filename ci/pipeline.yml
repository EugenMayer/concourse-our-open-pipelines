groups:
- name: docker-tools
  jobs:
  - build-docker-s3fs-image
  - build-docker-golang-glide-image
- name: opnsense
  jobs:
  - build-opnsense-cli
  - release-opnsense-cli
- name: concourse-resources
  jobs:
  - build-docker-image-resource
  - build-concourse-static-resource-image
- name: concourse-docker-images
  jobs:
  - build-docker-image-concourse-worker
  - build-docker-image-concourse-configurator
  - build-docker-image-concourse-worker-configurator
- name: atlassian-docker-images
  jobs:
  - build-docker-images-confluence
  - build-docker-images-jira

jobs:
- name: build-opnsense-cli
  serial:                      true
  build_logs_to_retain:        5
  plan:
  - aggregate:
    - get:                     kw-docker-lib
    - get:                     opnsense-cli-repo
      trigger:                 true
  - task:                      build-dist
    file:                      kw-docker-lib/ci/tasks/golang-build.yml
    input_mapping:
      repo:                    opnsense-cli-repo
    params:
      GO_REPO_FOLDER:          /go/src/github.com/eugenmayer/opnsense-cli
      MAKE_COMMAND:            build
    output_mapping:
      # the actual name in the task : <your alias>
      artifact:                opnsense-cli-dist
- name: release-opnsense-cli
  serial:                      true
  build_logs_to_retain:        5
  plan:
  - aggregate:
    - get:                     kw-docker-lib
    - get:                     opnsense-cli-version
      trigger:                 true
    - get:                     opnsense-cli-repo
  - task:                      build-dist
    file:                      kw-docker-lib/ci/tasks/golang-build.yml
    input_mapping:
      repo:                    opnsense-cli-repo
      version:                 opnsense-cli-version
    params:
      GO_REPO_FOLDER:          /go/src/github.com/eugenmayer/opnsense-cli
      MAKE_COMMAND:            release
    output_mapping:
      # the actual name in the task : <your alias>
      artifact:                opnsense-cli-dist
  - put:                       release-opnsense-cli
    params:
      name: opnsense-cli-version/version
      tag: opnsense-cli-version/version
      globs:
      - opnsense-cli-dist/dist/*

- name: build-docker-image-resource
  serial: true
  build_logs_to_retain: 5
  plan:
  - get: docker-image-resource
    trigger: true
  - task: build-docker-image-resource
    file: docker-image-resource/ci/build.yml
    input_mapping:
      docker-image-resource: docker-image-resource
    output_mapping:
      built-resource: docker-built-context
  - put: eugenmayer-docker-image-resource
    get_params: { skip_download : true }
    params:
      build: docker-built-context
      cache_tag: latest
      
- name: build-docker-image-concourse-worker
  serial: true
  build_logs_to_retain: 5
  plan:
  - get: docker-image-concourseci-worker-solid
    trigger: true
  - get: concourse-base-image
    trigger: true
    params:
      skip_download: true      
  - put: concourse-worker-solid-image
    params:
      build: docker-image-concourseci-worker-solid
      dockerfile: docker-image-concourseci-worker-solid/Dockerfile_3.8
      tag_static: ((concourse))
      cache_tag: latest  

- name: build-docker-image-concourse-configurator
  serial: true
  build_logs_to_retain: 10
  plan:
  - get: docker-image-concourseci-configurator-repo
    trigger: true
  - get: alpine-image
    trigger: true
    params:
      skip_download: true
  - put: concourse-configurator-image
    get_params: { skip_download : true }
    params:
      build: docker-image-concourseci-configurator-repo
      cache_tag: latest
- name: build-docker-image-concourse-worker-configurator
  serial: true
  build_logs_to_retain: 10
  plan:
  - get: docker-image-concourseci-worker-configurator-repo
    trigger: true
  - get: alpine-image
    trigger: true
    params:
      skip_download: true
  - put: concourse-worker-configurator-image
    get_params: { skip_download : true }
    params:
      build: docker-image-concourseci-worker-configurator-repo
      cache_tag: latest

- name: build-concourse-static-resource-image
  serial: true
  build_logs_to_retain: 5
  plan:
  - get: concourse-static-resource
    trigger: true
  - get: alpine-edge-image
    trigger: true
    params:
      skip_download: true
  - put: concourse-static-resource-image
    get_params: { skip_download : true }
    params:
      build: concourse-static-resource
      cache_tag: latest

- name: build-docker-golang-glide-image
  serial: true
  build_logs_to_retain: 5
  plan:
  - get: docker-image-golang-glide-repo
    trigger: true
  - get: golang-alpine-1.9-image
    trigger: true
    params:
      skip_download: true
  - put: eugenmayer-docker-image-golang-glide
    get_params: { skip_download : true }
    params:
      build: docker-image-golang-glide-repo
      cache_tag: latest
- name: build-docker-s3fs-image
  serial: true
  build_logs_to_retain: 5
  plan:
  - get: docker-image-s3fs
    trigger: true
  - get: debian-stretch-image
    trigger: true
    params:
      skip_download: true
  - put: eugenmayer-docker-image-aws-s3fs
    get_params: { skip_download : true }
    params:
      build: docker-image-s3fs
      cache_tag: latest

- name: build-docker-images-confluence
  serial: true
  build_logs_to_retain: 5
  plan:
    - get: pipeline-versions-src
      trigger: true
    - get: atlassian-confluence-docker-image-src
      trigger: true
    # A fixed earlier version
    - put: atlassian-confluence-docker-image
      get_params: { skip_download : true }
      params:
        build: atlassian-confluence-docker-image-src
        tag_static: ((confluence.early))
        build_args:
          CONFLUENCE_VERSION: ((confluence.early))
    # The latest version tagged as <version> and as 'latest'
    - put: atlassian-confluence-docker-image
      get_params: { skip_download : true }
      params:
        build: atlassian-confluence-docker-image-src
        tag_static: ((confluence.latest))
        tag_as_latest: true
        build_args:
          CONFLUENCE_VERSION: ((confluence.latest))

- name: build-docker-images-jira
  serial: true
  build_logs_to_retain: 5
  plan:
    - get: pipeline-versions-src
      trigger: true
    - get: atlassian-jira-docker-image-src
      trigger: true
    # A fixed earlier version
    - put: atlassian-jira-docker-image
      get_params: { skip_download : true }
      params:
        build: atlassian-jira-docker-image-src
        tag_static: en-((jira.early))
        build_args:
          JIRA_VERSION: ((jira.early))
    # The latest version tagged as <version> and as 'latest'
    - put: atlassian-jira-docker-image
      get_params: { skip_download : true }
      params:
        build: atlassian-jira-docker-image-src
        tag_static: en-((jira.latest))
        tag_as_latest: true
        build_args:
          JIRA_VERSION: ((jira.latest))

resources:
  - name: kw-docker-lib
    type: git
    check_every: 5m
    source:
      uri: ssh://git@code.kontextwork.de:2201/ci/docker_lib
      private_key: ((git_kw_ci_sshkey))

  - name: docker-image-s3fs
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-s3fs
      branch: master
 
  - name: docker-image-golang-glide-repo
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-golang-glide
      branch: master      

  - name: opnsense-cli-repo
    type: git
    source:
      uri: https://github.com/EugenMayer/opnsense-cli
      branch: master      
  - name: opnsense-cli-version
    type: concourse-git-semver-tag
    source:
      uri: https://github.com/EugenMayer/opnsense-cli
      branch: master
  - name: concourse-static-resource
    type: git
    source:
      uri: https://github.com/EugenMayer/concourse-static-resource
      branch: master

  - name: docker-image-resource
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-resource-ng
      branch: develop

  - name: docker-image-concourseci-worker-solid
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-concourseci-worker-solid
      branch: master
  - name: release-opnsense-cli
    type: github-release
    source:
      owner: eugenmayer
      repository: eugenmayer/opnsense-cli
      access_token: ((github_release_token.key))

  - name: docker-image-concourseci-configurator-repo
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-concourse-configurator
      branch: master

  - name: docker-image-concourseci-worker-configurator-repo
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-concourse-worker-configurator
      branch: master
 
  - name: concourse-base-image
    type: docker-image-resource-ng
    source:
      repository: concourse/concourse
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: ((concourse))

  - name: concourse-worker-solid-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/concourse-worker-solid
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: ((concourse))

  - name: concourse-configurator-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/concourse-configurator
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

  - name: concourse-worker-configurator-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/concourse-worker-configurator
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

  - name: debian-stretch-image
    type: docker-image-resource-ng
    source:
      repository: debian
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: stretch
  - name: golang-alpine-1.9-image
    type: docker-image-resource-ng
    source:
      repository: golang
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: 1.9-alpine      

  - name: alpine-image
    type: docker-image-resource-ng
    source:
      repository: alpine
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: 3.6

  - name: alpine-edge-image
    type: docker-image-resource-ng
    source:
      repository: alpine
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: edge

  - name: eugenmayer-docker-image-aws-s3fs
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/aws-s3fs
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest
  - name: eugenmayer-docker-image-golang-glide
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/golang-glide
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest             

  - name: eugenmayer-docker-image-resource
    type: docker-image
    source:
      repository: eugenmayer/concourse-docker-image-resource
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

  - name: concourse-static-resource-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/concourse-static-resource
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

  - name: atlassian-confluence-docker-image-src
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-atlassian-confluence
      branch: master

  - name: pipeline-versions-src
    type: git
    source:
      uri: https://github.com/EugenMayer/concourse-our-open-pipelines
      branch: master
      paths: ['ci/versions.yml']

  - name: atlassian-confluence-docker-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/confluence
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

  - name: atlassian-jira-docker-image-src
    type: git
    source:
      uri: https://github.com/EugenMayer/docker-image-atlassian-jira
      branch: master

  - name: atlassian-jira-docker-image
    type: docker-image-resource-ng
    source:
      repository: eugenmayer/jira
      username: ((dockerhub.user))
      password: ((dockerhub.password))
      tag: latest

resource_types:
- name: docker-image-resource-ng
  type: docker-image
  privileged: true
  source:
    repository: eugenmayer/concourse-docker-image-resource
    tag: latest
- name: concourse-git-semver-tag
  type: docker-image
  source:
    repository: eugenmayer/concourse-git-semver-tag-resource